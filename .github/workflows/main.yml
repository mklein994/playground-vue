name: Build and Lint Project
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [17]
    steps:
      - uses: actions/checkout@v2
        with:
          repository: "mklein994/sunrise-cli"
          path: sunrise-cli

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - uses: actions/checkout@v2
        with:
          path: playground-vue

      - run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            sunrise-cli/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('sunrise-cli/**/Cargo.lock') }}

      - run: wasm-pack build --target web sunrise-cli

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache .pnpm-store
        uses: actions/cache@v1
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('playground-vue/**/pnpm-lock.yaml') }}

      - name: Install
        run: corepack pnpm install -C playground-vue

      - name: Lint
        run: corepack pnpm run -C playground-vue lint:ci

      - name: Build
        run: corepack pnpm run -C playground-vue build

      - name: Sentry Release
        # You may pin to the exact commit or the version.
        # uses: getsentry/action-release@744e4b262278339b79fb39c8922efcae71e98e39
        uses: getsentry/action-release@v1.1.6
        with:
          # Set the environment for this release. E.g. "production" or "staging". Omit to skip adding deploy to release.
          environment: "production"
          # Space-separated list of paths to JavaScript sourcemaps. Omit to skip uploading sourcemaps.
          sourcemaps: ./dist/assets/
          # When false, omit marking the release as finalized and released.
          # finalize: # optional, default is true
          # When the flag is set and the previous release commit was not found in the repository, will create a release with the default commits count instead of failing the command.
          # ignore_missing: # optional
          # When the flag is set, command will not fail and just exit silently if no new commits for a given release have been found.
          # ignore_empty: # optional
          # Unix timestamp of the release start date. Omit for current time.
          # started_at: # optional
          # Identifier that uniquely identifies the releases. Omit to auto-generate one.
          # version: # optional
          # Value prepended to auto-generated version.
          # version_prefix: # optional
          # Specify whether to set commits for the release. Either "auto" or "skip".
          set_commits: auto
          # Space-separated list of projects. Defaults to the env variable "SENTRY_PROJECT" if not provided.
          projects: matthew-klein
          # Adds a prefix to source map urls after stripping them.
          # url_prefix: # optional
          # Will remove a common prefix from uploaded filenames. Useful for removing a path that is build-machine-specific.
          # strip_common_prefix: # optional
